# Refactor Notes & Known Risks

## Overview

This refactor transforms the AP Stats Consensus Quiz app from a simple local-first quiz UI into a more game-like, retro experience with:

- An 8-bit themed UI (pixel fonts, chunky borders, retro modals)
- A full "Study Buddy" room with physics, unit-based levels, and doors
- New sync status, restore, toast, and FRQ AI grading helpers
- Teacher dashboard, user management, roster import
- A standalone level editor

Core architecture remains:

- Single-page HTML + JS + CSS, no build step
- Offline-first client using LocalStorage / IndexedDB
- Optional Supabase via Railway proxy for sync
- Optional Railway WebSocket presence and FRQ grading backends 


## Major Feature Changes

### 1. Visual / UI Theme

- Old design: modern rounded UI, text-heavy buttons, standard icons.
- New design:
  - Retro 8-bit theme using Google pixel fonts
  - Square buttons, thick borders, strong shadows
  - Most labels replaced with pixel-art icons
  - New toast system, sync-status badge, and multiple retro-styled modals

**Notes**

- All major controls from the previous version *exist* but are now represented by pixel graphics instead of text.
- Discoverability is more dependent on icon design and the Study Buddy world.

---

### 2. Navigation & Lesson Flow

- Previously:
  - Quiz header rendered a visible “← Back to Lessons” button.
- Now:
  - Navigation back to lessons is wired through the Study Buddy world:
    - Black door in the room returned you to lessons.
  - Plan going forward:
    - Reintroduce a visible back button (likely an arrow icon) in the header.
    - Remove the black door as the primary “back” mechanism.
    - Keep the Study Buddy world for flavor, but don’t make it the *only* navigation path.

**Known Risks / Decisions**

- Relying solely on door interactions is confusing to new students, especially without verbal explanation.
- Action: re-add a clear back button in the quiz UI; demote the door to “fun alternative,” not required navigation.

---

### 3. FAB Menu & Doors

- Previously:
  - FAB (floating action button) was visible in the UI, bottom-right.
- Now:
  - FAB is hidden by default; can be opened via a **pink door** in the Study Buddy room.
  - Desired change: make the pink door also clickable in 2D canvas (mouse/touch), not just sprite-collision based.

**Known Risks / Decisions**

- Current behavior over-emphasizes “game” affordances and under-emphasizes obvious UI.
- Plan:
  - Keep the pink door as a game-like trigger.
  - Also support direct clicking on the pink door in the canvas.
  - Ensure the FAB or its functions are still accessible in non-canvas contexts.

---

### 4. Study Buddy Room & Sprites

- New: `study_buddy_room.js`, `unit_block.js`, `menu_door.js` implement:
  - Unit-based levels, pushable blocks, inclines/cliffs
  - Exit doors (with stars when progress conditions met)
  - Menu door fixed in view
  - Room-aware physics and camera follow in `player_sprite.js`
- `sprite_manager.js`:
  - Peer handling is now case-insensitive.
  - If there is no `currentUsername`, peer sprites are cleared.

**Known Risks / Decisions**

- **Peer-sprite visibility**
  - Before: peers visible for “anonymous” users with autogenerated names.
  - Now: peers vanish if no `currentUsername` is set.
  - Desired behavior:
    - Anonymous / auto-generated usernames are still acceptable and should still see peers.
    - Peer-sprite view should remain a “wow” moment, not regress.

- **Door event dependency**
  - Navigation now depends on door events (`studyBuddyDoorEnter`, `studyBuddyMenuDoorEnter`).
  - If listeners misfire, player could get stuck mid-dissolve.

- **Rendering compatibility**
  - Uses `ctx.roundRect` for blocks; may fail on older browsers if not supported.

---

### 5. Data Layer, Sync & Restore

- New frontend modules:
  - `db.js` (Dexie) for IndexedDB storage
  - `sync_status.js` for sync status tracking
  - `restore_ui.js` for restore progress modal
  - `toast.js` for notifications
- `currentUsername` / `classData` now come from `db.js` instead of inline globals.
- Manual “Restore from Cloud” button in the sync modal has been removed in favor of the new restore UX.

**Known Risks / Decisions**

- **Offline-first fragility**
  - If `db.js`, `SyncStatus`, or related scripts fail to load, there is risk of:
    - `currentUsername` / `classData` being undefined
    - Errors when calling `SyncStatus` helpers
  - Need to verify the app still works **fully offline** with no network.

- **Restore behavior**
  - Old “Restore from Cloud” button is gone.
  - New restore flow is considered acceptable by design, but must be tested for:
    - Discoverability
    - Correct behavior when Supabase is unreachable

- **Answer CSV**
  - A CSV-like file with real-looking answer rows is now committed.
  - For this project, strict privacy is not a functional concern, but the file may increase repo size and should be treated as intentional “pedagogy data”.

---

### 6. FRQ Solutions & AI Grading

- FRQ UI:
  - Solutions moved into sidebar.
  - Scoring guide is hidden by default, revealed via “View Scoring Guide” toggle.
  - Two-phase chart rendering is preserved.
- `frq_grader.js`:
  - Integrates with Railway server FRQ endpoints.
  - Sends student answer text + chart data to external LLMs (Gemini/Groq) for grading.
  - Designed to be optional; FRQ content should still be viewable without grading.

**Known Risks / Decisions**

- **Behavior change:** solutions no longer auto-show; students must click to view the scoring guide.
- **Connectivity:** AI grading fails when offline or when environment keys are missing.
- Designer intent:
  - Offline FRQ viewing and human scoring behavior is more important than AI grading.
  - Need to confirm the app still shows prompts and keys correctly with no AI connectivity.

---

### 7. Teacher Dashboard, User Management & Roster

- New `user_management.js`:
  - Creates users, sets passwords, handles teacher login, toggles teacher FAB, logs out (clears IndexedDB + LocalStorage).
- New `teacher_dashboard.js` & `docs/import_roster.html`:
  - Teacher tools: roster list, CSV bulk import, data export/import, password resets, viewing sync status.

**Known Risks /  Decisions**

- Passwords and master password are currently treated as **trusted client-side state**.
- For this project, conventional security/privacy concerns are intentionally de-prioritized in favor of pedagogy and transparency.
- Still important to:
  - Ensure the teacher dashboard is fully functional.
  - Ensure student experiences aren’t broken if Railway user endpoints are down.

---

### 8. Railway Server & FRQ Grades

- Railway server (`railway-server/server.js`):
  - Adds user management endpoints and FRQ grading endpoints.
  - Uses external LLM APIs (Groq/Gemini) and Supabase `frq_grades` table.
- `railway_client.js`:
  - Renames `USE_RAILWAY` → `RC_USE_RAILWAY`, `RAILWAY_SERVER_URL` → `RC_RAILWAY_SERVER_URL`.
  - Handles Study Buddy WebSocket events and reports state to `SyncStatus`.

**Known Risks / Decisions**

- **API dependency:**
  - Login/registration and FRQ grading now depend on Railway being reachable.
  - App must still function as a local/offline quiz app even if Railway is unreachable.
- **Breaking constant rename:**
  - Any code still referencing `USE_RAILWAY` / `RAILWAY_SERVER_URL` must be updated or shimed.
- **Supabase FRQ data & RLS:**
  - FRQ response data is intentionally transparent and readable for learning; strict access control is not a current design priority, but should be documented as such.
