<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topics 3.6‚Äì3.7: Selecting an Experimental Design & Inference</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 880px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background: #f9f9f9;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .header-left { font-weight: bold; color: #003366; }
        .header-center { font-weight: bold; }
        .header-right { font-weight: bold; color: #003366; }
        h1 { text-align: center; color: #003366; margin-bottom: 5px; font-size: 1.5rem; }
        .subtitle { text-align: center; font-style: italic; color: #555; margin-bottom: 10px; }
        .worksheet-label { text-align: center; font-weight: bold; margin-bottom: 20px; }
        .student-info { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .student-info label { font-weight: bold; }
        .student-info input {
            border: none;
            border-bottom: 1px solid #333;
            background: transparent;
            padding: 2px 5px;
            font-size: 1em;
        }
        .objective-box {
            border: 2px solid #003366;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            background: white;
        }
        .objective-box strong { color: #003366; }
        .vocab-box {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px;
        }
        .vocab-box h3 { margin-top: 0; color: #003366; }
        .vocab-table { width: 100%; }
        .vocab-table td { padding: 5px 0; vertical-align: top; }
        .vocab-table td:first-child { font-weight: bold; width: 210px; color: #003366; }
        .section { margin-bottom: 28px; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 6px;
            margin-bottom: 12px;
        }
        .section-header h2 { margin: 0; color: #003366; font-size: 1.15rem; }
        .timestamp { color: #666; font-size: 0.95rem; }
        .question {
            margin-bottom: 12px;
            padding-left: 6px;
            position: relative;
        }
        .question-number {
            font-weight: bold;
            color: #003366;
            margin-right: 8px;
        }
        .sub-questions { margin-left: 22px; margin-top: 6px; }
        .sub-question { margin: 4px 0; }
        .blank {
            border: none;
            border-bottom: 1px solid #003366;
            background: transparent;
            padding: 2px 4px;
            font-size: 1em;
            min-width: 90px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .blank:focus {
            outline: none;
            border-bottom: 2px solid #003366;
            background: #f0f7ff;
        }
        .blank.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }
        .blank.partial {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .blank.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .blank.revealed {
            background-color: #e2e3f3;
            border-color: #6c757d;
        }
        .model-box, .note-box {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            background: #fff;
            margin: 10px 0 14px;
        }
        .note-box { background: #f7fbff; border-color: #cce0ff; }
        .hint { color: #777; font-size: 0.92em; margin-left: 6px; }
        textarea {
            width: 100%;
            min-height: 90px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        .exit-ticket {
            border: 2px solid #003366;
            border-radius: 6px;
            padding: 12px;
            background: #f0f4ff;
            margin-top: 18px;
        }
        
        /* Control buttons */
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .btn-check {
            background: #003366;
            color: #fff;
        }
        .btn-show {
            background: #6c757d;
            color: #fff;
        }
        .btn-reset {
            background: #dc3545;
            color: #fff;
        }
        .btn-print {
            background: #28a745;
            color: #fff;
        }
        
        /* Score display */
        .score-display {
            font-weight: bold;
            color: #003366;
            padding: 8px 12px;
            background: #e8f4fc;
            border-radius: 4px;
            display: none;
        }
        .score-display.visible { display: inline-block; }
        
        /* Aggregate drawer */
        .aggregate-drawer {
            position: fixed;
            top: 0;
            right: -380px;
            width: 360px;
            height: 100%;
            background: #fff;
            box-shadow: -2px 0 8px rgba(0,0,0,0.15);
            transition: right 0.25s ease;
            padding: 16px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        .aggregate-drawer.open { right: 0; }
        .aggregate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .aggregate-title { font-weight: bold; color: #003366; }
        .aggregate-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }
        .aggregate-close:hover { color: #333; }
        
        .aggregate-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chart-container {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .chart-label {
            font-size: 0.85em;
            color: #003366;
            font-weight: bold;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }
        
        .chart-count {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 8px;
        }
        
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .bar-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bar-label {
            width: 100px;
            font-size: 0.8em;
            color: #333;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .bar-track {
            flex: 1;
            height: 22px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            padding-left: 6px;
        }
        
        .bar-value {
            font-size: 0.75em;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        .bar-value.outside {
            color: #333;
            text-shadow: none;
            position: absolute;
            left: 6px;
        }
        
        .aggregate-trigger {
            margin-top: 6px;
            padding: 4px 10px;
            background: #003366;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .aggregate-trigger:hover {
            background: #004488;
        }
        .save-indicator {
            font-size: 0.9em;
            color: #22863a;
            margin-left: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .save-indicator.visible { opacity: 1; }
        
        /* Particles */
        .particle-up {
            position: absolute;
            font-size: 14px;
            color: #22863a;
            pointer-events: none;
            animation: floatUp 0.9s ease-out forwards;
        }
        @keyframes floatUp {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-16px); }
        }
        .particle-snow {
            position: absolute;
            font-size: 14px;
            color: #3182ce;
            pointer-events: none;
            animation: snowDrift 1.4s ease-out forwards;
        }
        @keyframes snowDrift {
            from { opacity: 1; transform: translateY(0) rotate(0deg); }
            to { opacity: 0; transform: translateY(-18px) rotate(10deg); }
        }
        
        /* Diagram SVG styling */
        .diagram-container {
            margin: 15px 0;
            text-align: center;
        }
        .diagram-container svg {
            max-width: 100%;
            height: auto;
        }
        
        /* Print styles */
        @media print {
            body { background: white; padding: 0; }
            .controls, .aggregate-trigger, .aggregate-drawer { display: none !important; }
            .blank { 
                border-bottom: 1px solid #000;
                background: transparent !important;
            }
            .save-indicator { display: none; }
            .section { page-break-inside: avoid; }
            .exit-ticket { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">AP Statistics</div>
        <div class="header-center">Unit 3: Collecting Data</div>
        <div class="header-right">Lessons 6‚Äì7</div>
    </div>

    <h1>Topics 3.6‚Äì3.7: Selecting an Experimental Design & Inference</h1>
    <div class="subtitle">How do we choose and interpret well-designed experiments?</div>
    <div class="worksheet-label"><strong>Video Follow-Along Worksheet (Live)</strong></div>

    <div class="student-info">
        <label>Name: <input type="text" id="studentName" placeholder="Your name"></label>
        <label>Period: <input type="text" id="studentClass" placeholder="Period"></label>
        <label>Username: <input type="text" id="worksheetUsername" placeholder="Username (to save)"></label>
    </div>
    
    <div class="controls">
        <button class="btn-check" onclick="checkAnswers()">‚úì Check Answers</button>
        <button class="btn-show" onclick="showAnswers()">üëÅ Show Answers</button>
        <button class="btn-reset" onclick="resetAnswers()">‚Ü∫ Reset</button>
        <button class="btn-print" onclick="window.print()">üñ® Print</button>
        <span class="score-display" id="scoreDisplay"></span>
    </div>

    <div class="objective-box">
        <div><strong>Learning Objective (VAR-3.D):</strong> Explain why a particular experimental design is appropriate.</div>
        <div><strong>Learning Objective (VAR-3.E):</strong> Interpret the results of a well-designed experiment.</div>
        <div style="margin-top: 8px;"><strong>Essential Knowledge:</strong> A randomized block design separates natural variability from treatment effects. Statistical inference allows us to attribute conclusions from sample data to the population. Statistically significant differences are evidence that treatments caused the observed effect.</div>
    </div>

    <div class="vocab-box">
        <h3>Key Vocabulary</h3>
        <table class="vocab-table">
            <tr>
                <td>Randomized Block Design</td>
                <td>Subjects are grouped into blocks by a characteristic, then randomly assigned to treatments within each block.</td>
            </tr>
            <tr>
                <td>Matched Pairs Design</td>
                <td>A special case of blocking that uses pairs of similar experimental units, with one receiving each treatment.</td>
            </tr>
            <tr>
                <td>Blinding</td>
                <td>Subjects and/or researchers are unaware of which treatment is being administered.</td>
            </tr>
            <tr>
                <td>Statistical Significance</td>
                <td>Observed differences are too large to be reasonably attributed to chance alone.</td>
            </tr>
            <tr>
                <td>Statistical Inference</td>
                <td>Using sample data to draw conclusions about a population or treatment.</td>
            </tr>
        </table>
    </div>

    <!-- ============ VIDEO 1 ============ -->
    <div class="section">
        <div class="section-header">
            <h2>Video 1: Blocking & Blinding (Topic 3.6)</h2>
            <span class="timestamp">5:54</span>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part A: Introduction & High Cholesterol Example</h2>
            <span class="timestamp">[0:00‚Äì0:53]</span>
        </div>
        <div class="question">
            <span class="question-number">1.</span>
            In this video, we will learn how <input type="text" class="blank" data-answer="blocking" style="width: 130px;"> can improve the design of an experiment and under what conditions an experiment can be <input type="text" class="blank" data-answer="blinded|double-blinded|double blinded" style="width: 130px;">.
        </div>
        <div class="question">
            <span class="question-number">2.</span>
            The "High Cholesterol" example is a <input type="text" class="blank" data-answer="former AP question|free-response question|frq" style="width: 180px;"> from a previous AP exam.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part B: Completely Randomized Design</h2>
            <span class="timestamp">[0:53‚Äì2:29]</span>
        </div>
        <div class="question">
            <span class="question-number">3.</span>
            A well-designed experiment includes four key components: <input type="text" class="blank" data-answer="comparison" style="width: 130px;"> of treatments, <input type="text" class="blank" data-answer="random assignment|randomization" style="width: 150px;">, replication, and <input type="text" class="blank" data-answer="control" style="width: 100px;">.
        </div>
        <div class="question">
            <span class="question-number">4.</span>
            To randomly assign 200 volunteers to two groups, we can number them 1 to 200, then use a <input type="text" class="blank" data-answer="random number generator|table of random digits" style="width: 190px;"> to select 100 numbers without repeat.
        </div>
        <div class="question">
            <span class="question-number">5.</span>
            The 100 randomly selected volunteers receive the <input type="text" class="blank" data-answer="new" style="width: 70px;"> drug, and the remaining 100 receive the <input type="text" class="blank" data-answer="old" style="width: 70px;"> drug.
        </div>
        <div class="question">
            <span class="question-number">6.</span>
            After treatment, we measure and compare the <input type="text" class="blank" data-answer="mean cholesterol levels|cholesterol levels" style="width: 180px;"> for both groups.
        </div>
        
        <!-- Completely Randomized Design Diagram -->
        <div class="diagram-container">
            <svg width="700" height="120" viewBox="0 0 700 120">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#003366"/>
                    </marker>
                </defs>
                <!-- Volunteers box -->
                <rect x="10" y="40" width="90" height="40" fill="#e8f4fc" stroke="#003366" stroke-width="2" rx="4"/>
                <text x="55" y="58" text-anchor="middle" font-size="11" fill="#003366">Volunteers</text>
                <text x="55" y="72" text-anchor="middle" font-size="10" fill="#666">(200)</text>
                
                <!-- Arrow to random -->
                <line x1="100" y1="60" x2="140" y2="60" stroke="#003366" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- Random Assignment box -->
                <rect x="145" y="40" width="90" height="40" fill="#fff3cd" stroke="#003366" stroke-width="2" rx="4"/>
                <text x="190" y="55" text-anchor="middle" font-size="10" fill="#003366">Random</text>
                <text x="190" y="68" text-anchor="middle" font-size="10" fill="#003366">Assignment</text>
                
                <!-- Arrows to groups -->
                <line x1="235" y1="50" x2="280" y2="30" stroke="#003366" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="235" y1="70" x2="280" y2="90" stroke="#003366" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- Group 1 -->
                <rect x="285" y="10" width="80" height="35" fill="#d4edda" stroke="#003366" stroke-width="2" rx="4"/>
                <text x="325" y="25" text-anchor="middle" font-size="10" fill="#003366">Group 1</text>
                <text x="325" y="38" text-anchor="middle" font-size="9" fill="#666">(100)</text>
                
                <!-- Group 2 -->
                <rect x="285" y="75" width="80" height="35" fill="#f8d7da" stroke="#003366" stroke-width="2" rx="4"/>
                <text x="325" y="90" text-anchor="middle" font-size="10" fill="#003366">Group 2</text>
                <text x="325" y="103" text-anchor="middle" font-size="9" fill="#666">(100)</text>
                
                <!-- Arrows to treatments -->
                <line x1="365" y1="27" x2="400" y2="27" stroke="#003366" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="365" y1="93" x2="400" y2="93" stroke="#003366" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- New Drug -->
                <rect x="405" y="10" width="80" height="35" fill="#d4edda" stroke="#28a745" stroke-width="2" rx="4"/>
                <text x="445" y="32" text-anchor="middle" font-size="10" fill="#003366">New Drug</text>
                
                <!-- Old Drug -->
                <rect x="405" y="75" width="80" height="35" fill="#f8d7da" stroke="#dc3545" stroke-width="2" rx="4"/>
                <text x="445" y="97" text-anchor="middle" font-size="10" fill="#003366">Old Drug</text>
                
                <!-- Arrows to compare -->
                <line x1="485" y1="27" x2="530" y2="50" stroke="#003366" stroke-width="2" marker-end="url(#arrowhead)"/>
                <line x1="485" y1="93" x2="530" y2="70" stroke="#003366" stroke-width="2" marker-end="url(#arrowhead)"/>
                
                <!-- Compare box -->
                <rect x="535" y="40" width="90" height="40" fill="#e8f4fc" stroke="#003366" stroke-width="2" rx="4"/>
                <text x="580" y="55" text-anchor="middle" font-size="10" fill="#003366">Compare</text>
                <text x="580" y="68" text-anchor="middle" font-size="10" fill="#003366">Cholesterol</text>
            </svg>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part C: Randomized Block Design</h2>
            <span class="timestamp">[2:51‚Äì4:16]</span>
        </div>
        <div class="question">
            <span class="question-number">7.</span>
            From the prompt: "High cholesterol level can be reduced by <input type="text" class="blank" data-answer="exercise" style="width: 110px;"> <em>or</em> by drug treatment."
        </div>
        <div class="question">
            <span class="question-number">8.</span>
            This suggests that <input type="text" class="blank" data-answer="exercise level|exercise" style="width: 140px;"> could be a blocking variable that affects cholesterol levels.
        </div>
        <div class="question">
            <span class="question-number">9.</span>
            In a randomized block design, we first separate volunteers into <input type="text" class="blank" data-answer="blocks" style="width: 90px;"> based on a characteristic (here: high vs. low exercise), <em>then</em> perform randomization <input type="text" class="blank" data-answer="within each block|within blocks" style="width: 150px;">.
        </div>
        <div class="question">
            <span class="question-number">10.</span>
            We then compare cholesterol levels <input type="text" class="blank" data-answer="within the blocks|within blocks|within each block" style="width: 150px;"> and overall.
        </div>
        
        <!-- Randomized Block Design Diagram -->
        <div class="diagram-container">
            <svg width="700" height="160" viewBox="0 0 700 160">
                <defs>
                    <marker id="arrow2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#003366"/>
                    </marker>
                </defs>
                <!-- Volunteers -->
                <rect x="10" y="60" width="80" height="40" fill="#e8f4fc" stroke="#003366" stroke-width="2" rx="4"/>
                <text x="50" y="85" text-anchor="middle" font-size="11" fill="#003366">Volunteers</text>
                
                <!-- Block arrows -->
                <line x1="90" y1="70" x2="130" y2="35" stroke="#003366" stroke-width="2" marker-end="url(#arrow2)"/>
                <line x1="90" y1="90" x2="130" y2="125" stroke="#003366" stroke-width="2" marker-end="url(#arrow2)"/>
                
                <!-- Block 1 (HIGH) -->
                <rect x="135" y="15" width="90" height="40" fill="#fff3cd" stroke="#003366" stroke-width="2" rx="4" stroke-dasharray="5,3"/>
                <text x="180" y="32" text-anchor="middle" font-size="10" fill="#003366" font-weight="bold">Block 1</text>
                <text x="180" y="46" text-anchor="middle" font-size="9" fill="#666">HIGH exercise</text>
                
                <!-- Block 2 (LOW) -->
                <rect x="135" y="105" width="90" height="40" fill="#fff3cd" stroke="#003366" stroke-width="2" rx="4" stroke-dasharray="5,3"/>
                <text x="180" y="122" text-anchor="middle" font-size="10" fill="#003366" font-weight="bold">Block 2</text>
                <text x="180" y="136" text-anchor="middle" font-size="9" fill="#666">LOW exercise</text>
                
                <!-- Random within blocks -->
                <line x1="225" y1="35" x2="265" y2="35" stroke="#003366" stroke-width="2" marker-end="url(#arrow2)"/>
                <line x1="225" y1="125" x2="265" y2="125" stroke="#003366" stroke-width="2" marker-end="url(#arrow2)"/>
                
                <!-- Random boxes -->
                <rect x="270" y="15" width="70" height="40" fill="#ffeeba" stroke="#003366" stroke-width="1" rx="3"/>
                <text x="305" y="38" text-anchor="middle" font-size="9" fill="#003366">Random</text>
                <rect x="270" y="105" width="70" height="40" fill="#ffeeba" stroke="#003366" stroke-width="1" rx="3"/>
                <text x="305" y="128" text-anchor="middle" font-size="9" fill="#003366">Random</text>
                
                <!-- Treatment splits Block 1 -->
                <line x1="340" y1="25" x2="380" y2="15" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                <line x1="340" y1="45" x2="380" y2="55" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                
                <!-- Treatment splits Block 2 -->
                <line x1="340" y1="115" x2="380" y2="105" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                <line x1="340" y1="135" x2="380" y2="145" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                
                <!-- Treatments Block 1 -->
                <rect x="385" y="2" width="60" height="25" fill="#d4edda" stroke="#28a745" stroke-width="1" rx="3"/>
                <text x="415" y="18" text-anchor="middle" font-size="9" fill="#003366">New</text>
                <rect x="385" y="43" width="60" height="25" fill="#f8d7da" stroke="#dc3545" stroke-width="1" rx="3"/>
                <text x="415" y="59" text-anchor="middle" font-size="9" fill="#003366">Old</text>
                
                <!-- Treatments Block 2 -->
                <rect x="385" y="92" width="60" height="25" fill="#d4edda" stroke="#28a745" stroke-width="1" rx="3"/>
                <text x="415" y="108" text-anchor="middle" font-size="9" fill="#003366">New</text>
                <rect x="385" y="133" width="60" height="25" fill="#f8d7da" stroke="#dc3545" stroke-width="1" rx="3"/>
                <text x="415" y="149" text-anchor="middle" font-size="9" fill="#003366">Old</text>
                
                <!-- Arrows to compare -->
                <line x1="445" y1="14" x2="500" y2="60" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                <line x1="445" y1="55" x2="500" y2="70" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                <line x1="445" y1="104" x2="500" y2="85" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                <line x1="445" y1="145" x2="500" y2="95" stroke="#003366" stroke-width="1.5" marker-end="url(#arrow2)"/>
                
                <!-- Compare box -->
                <rect x="505" y="55" width="90" height="50" fill="#e8f4fc" stroke="#003366" stroke-width="2" rx="4"/>
                <text x="550" y="75" text-anchor="middle" font-size="10" fill="#003366">Compare</text>
                <text x="550" y="90" text-anchor="middle" font-size="9" fill="#666">within blocks</text>
                <text x="550" y="102" text-anchor="middle" font-size="9" fill="#666">& overall</text>
            </svg>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part D: Double Blinding</h2>
            <span class="timestamp">[4:16‚Äì5:27]</span>
        </div>
        <div class="question">
            <span class="question-number">11.</span>
            If asked a yes/no question on the AP exam, make sure you answer <input type="text" class="blank" data-answer="yes or no|yes/no" style="width: 120px;"> somewhere in your response.
        </div>
        <div class="question">
            <span class="question-number">12.</span>
            Double blinding is possible when both the <input type="text" class="blank" data-answer="subjects|participants" style="width: 120px;"> and the <input type="text" class="blank" data-answer="researchers|experimenters" style="width: 120px;"> are unaware of what treatments are being given to each subject.
        </div>
        <div class="question">
            <span class="question-number">13.</span>
            This works best if the treatments are similar in <input type="text" class="blank" data-answer="look|appearance" style="width: 110px;">, taste, or administration method.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part E: Key Takeaways</h2>
            <span class="timestamp">[5:27‚Äì5:46]</span>
        </div>
        <div class="question">
            <span class="question-number">14.</span>
            A randomized block design helps to separate <input type="text" class="blank" data-answer="natural variability" style="width: 160px;"> from differences due to the blocking variable.
        </div>
        <div class="question">
            <span class="question-number">15.</span>
            Blinding is possible when subjects and/or researchers are <input type="text" class="blank" data-answer="unaware" style="width: 120px;"> of the treatment being administered.
        </div>
    </div>

    <!-- ============ VIDEO 2 ============ -->
    <div class="section">
        <div class="section-header">
            <h2>Video 2: Matched Pairs & Replication (Topic 3.6)</h2>
            <span class="timestamp">6:48</span>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part A: Tractor Plots Introduction</h2>
            <span class="timestamp">[0:00‚Äì1:22]</span>
        </div>
        <div class="question">
            <span class="question-number">16.</span>
            This example is from the <input type="text" class="blank" data-answer="2006" style="width: 70px;"> AP exam (Form B).
        </div>
        <div class="question">
            <span class="question-number">17.</span>
            In this study, "draft" refers to the <input type="text" class="blank" data-answer="energy|force" style="width: 100px;"> needed to pull a plow.
        </div>
        <div class="question">
            <span class="question-number">18.</span>
            Identifying components of this experiment:
            <div class="sub-questions">
                <div class="sub-question">‚Ä¢ Response variable: <input type="text" class="blank" data-answer="the amount of draft|draft|amount of draft" style="width: 180px;"></div>
                <div class="sub-question">‚Ä¢ Treatments: <input type="text" class="blank" data-answer="standard hitch and new hitch|the two hitches|standard vs new hitch" style="width: 220px;"></div>
                <div class="sub-question">‚Ä¢ Experimental units: <input type="text" class="blank" data-answer="the plots of land|plots|plots of land" style="width: 170px;"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part B: Evaluating Randomization</h2>
            <span class="timestamp">[2:10‚Äì2:41]</span>
        </div>
        <div class="question">
            <span class="question-number">19.</span>
            Was randomization properly used? <input type="text" class="blank" data-answer="yes" style="width: 60px;">
        </div>
        <div class="question">
            <span class="question-number">20.</span>
            Evidence: "It was <input type="text" class="blank" data-answer="randomly determined" style="width: 170px;"> which plot was to be plowed using the standard hitch."
        </div>
        <div class="question">
            <span class="question-number">21.</span>
            The two <input type="text" class="blank" data-answer="hitches" style="width: 100px;"> (treatments) were randomly assigned to the two <input type="text" class="blank" data-answer="plots" style="width: 100px;"> (experimental units).
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part C: Evaluating Replication</h2>
            <span class="timestamp">[3:09‚Äì4:02]</span>
        </div>
        <div class="question">
            <span class="question-number">22.</span>
            Was replication properly used? <input type="text" class="blank" data-answer="no" style="width: 60px;">
        </div>
        <div class="question">
            <span class="question-number">23.</span>
            <strong>Key insight:</strong> Replication means applying each treatment to a sufficient number of <input type="text" class="blank" data-answer="experimental units" style="width: 160px;">, not just taking multiple measurements.
        </div>
        <div class="question">
            <span class="question-number">24.</span>
            Problem: Each treatment was applied to only <input type="text" class="blank" data-answer="one|1" style="width: 60px;"> experimental unit (plot). There were 25 measurements per plot, but this is <em>not</em> replication.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part D: Confounding Variable</h2>
            <span class="timestamp">[4:17‚Äì5:11]</span>
        </div>
        <div class="question">
            <span class="question-number">25.</span>
            The draft is affected by environmental conditions such as <input type="text" class="blank" data-answer="soil type|soil" style="width: 100px;">, terrain, and <input type="text" class="blank" data-answer="moisture" style="width: 100px;">.
        </div>
        <div class="question">
            <span class="question-number">26.</span>
            Because each hitch was used on only one plot, we cannot determine if the difference in draft is due to the <input type="text" class="blank" data-answer="hitch" style="width: 80px;"> or the characteristics of that specific <input type="text" class="blank" data-answer="plot" style="width: 80px;">.
        </div>
        <div class="question">
            <span class="question-number">27.</span>
            The treatments (hitches) are <input type="text" class="blank" data-answer="confounded" style="width: 120px;"> with the plots.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part E: Improving the Design</h2>
            <span class="timestamp">[5:11‚Äì6:20]</span>
        </div>
        <div class="question">
            <span class="question-number">28.</span>
            <strong>Improvement 1:</strong> Split each plot in <input type="text" class="blank" data-answer="half" style="width: 70px;"> and use random assignment to determine which hitch is used on either half. This reduces the <input type="text" class="blank" data-answer="confounding" style="width: 120px;"> effect of the plot.
        </div>
        <div class="question">
            <span class="question-number">29.</span>
            <strong>Improvement 2:</strong> Use more than <input type="text" class="blank" data-answer="two|2" style="width: 60px;"> experimental units.
        </div>
        <div class="question">
            <span class="question-number">30.</span>
            Don't forget to mention that you will measure the <input type="text" class="blank" data-answer="response variable|draft" style="width: 150px;"> after applying the treatments!
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part F: Key Takeaways</h2>
            <span class="timestamp">[6:20‚Äì6:48]</span>
        </div>
        <div class="question">
            <span class="question-number">31.</span>
            Proper replication requires that multiple <input type="text" class="blank" data-answer="experimental units" style="width: 160px;"> receive the same treatment.
        </div>
        <div class="question">
            <span class="question-number">32.</span>
            A <input type="text" class="blank" data-answer="matched pairs" style="width: 130px;"> design involves blocks of two similar experimental units, one receiving each treatment. <em>OR</em> each experimental unit receives <input type="text" class="blank" data-answer="both" style="width: 70px;"> treatments in random order.
        </div>
    </div>

    <!-- ============ VIDEO 3 ============ -->
    <div class="section">
        <div class="section-header">
            <h2>Video 3: Inference & Experiments (Topic 3.7)</h2>
            <span class="timestamp">5:50</span>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part A: Introduction & Learning Goals</h2>
            <span class="timestamp">[0:00‚Äì0:36]</span>
        </div>
        <div class="question">
            <span class="question-number">33.</span>
            Three learning goals for this video:
            <div class="sub-questions">
                <div class="sub-question">‚Ä¢ What is <input type="text" class="blank" data-answer="statistical inference" style="width: 160px;">?</div>
                <div class="sub-question">‚Ä¢ How does <input type="text" class="blank" data-answer="random assignment" style="width: 160px;"> help determine statistical significance?</div>
                <div class="sub-question">‚Ä¢ Under what conditions can results be <input type="text" class="blank" data-answer="generalized" style="width: 130px;"> to the population?</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part B: The R√©sum√© Experiment</h2>
            <span class="timestamp">[0:36‚Äì2:19]</span>
        </div>
        <div class="question">
            <span class="question-number">34.</span>
            In this study, two r√©sum√©s were identical except for the <input type="text" class="blank" data-answer="names|name" style="width: 100px;"> (Greg Baker vs. Jamal Jones).
        </div>
        <div class="question">
            <span class="question-number">35.</span>
            R√©sum√©s were sent to employers in <input type="text" class="blank" data-answer="Boston" style="width: 100px;"> and <input type="text" class="blank" data-answer="Chicago" style="width: 100px;">.
        </div>
        <div class="question">
            <span class="question-number">36.</span>
            Each employer was <input type="text" class="blank" data-answer="randomly assigned" style="width: 150px;"> a r√©sum√© with either a commonly White name or commonly African-American name.
        </div>
        <div class="question">
            <span class="question-number">37.</span>
            Check if this is a well-designed experiment:
            <div class="sub-questions">
                <div class="sub-question">‚Ä¢ Comparison? <input type="text" class="blank" data-answer="yes" style="width: 60px;"> ‚Äî Two groups (White vs. African-American names)</div>
                <div class="sub-question">‚Ä¢ Random assignment? <input type="text" class="blank" data-answer="yes" style="width: 60px;"> ‚Äî Each company given a random name</div>
                <div class="sub-question">‚Ä¢ Replication? <input type="text" class="blank" data-answer="yes" style="width: 60px;"> ‚Äî <input type="text" class="blank" data-answer="2445" style="width: 70px;"> r√©sum√©s for each group</div>
                <div class="sub-question">‚Ä¢ Control? <input type="text" class="blank" data-answer="yes" style="width: 60px;"> ‚Äî All r√©sum√©s equal except for name</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part C: Results of the R√©sum√© Experiment</h2>
            <span class="timestamp">[2:19‚Äì3:00]</span>
        </div>
        <div class="question">
            <span class="question-number">38.</span>
            Callback rate for r√©sum√©s with White names: <input type="text" class="blank" data-answer="10.08|10.08%" style="width: 80px;">%
        </div>
        <div class="question">
            <span class="question-number">39.</span>
            Callback rate for r√©sum√©s with African-American names: <input type="text" class="blank" data-answer="6.70|6.7|6.70%" style="width: 80px;">%
        </div>
        <div class="question">
            <span class="question-number">40.</span>
            Difference between groups: <input type="text" class="blank" data-answer="3.38|3.38%" style="width: 70px;">%
        </div>
        <div class="question">
            <span class="question-number">41.</span>
            The key question: Is this difference due to <input type="text" class="blank" data-answer="chance" style="width: 90px;"> alone, or is it because of the <input type="text" class="blank" data-answer="type of name|names" style="width: 130px;">?
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part D: Statistical Significance</h2>
            <span class="timestamp">[3:00‚Äì4:44]</span>
        </div>
        <div class="question">
            <span class="question-number">42.</span>
            Random assignment allows us to conclude that very large observed changes are not merely by <input type="text" class="blank" data-answer="chance" style="width: 100px;"> (statistically significant).
        </div>
        <div class="question">
            <span class="question-number">43.</span>
            Statistically significant differences between treatment groups are evidence that the <input type="text" class="blank" data-answer="treatments|treatment" style="width: 130px;"> caused the effect.
        </div>
        <div class="question">
            <span class="question-number">44.</span>
            Two possibilities for the 3.38% difference:
            <div class="sub-questions">
                <div class="sub-question">‚Ä¢ Option 1: Type of name does <em>not</em> affect callback rate; the difference happened by <input type="text" class="blank" data-answer="chance" style="width: 100px;">.</div>
                <div class="sub-question">‚Ä¢ Option 2: Type of name <input type="text" class="blank" data-answer="affects|does affect" style="width: 110px;"> callback rate.</div>
            </div>
        </div>
        <div class="question">
            <span class="question-number">45.</span>
            The probability of observing an outcome this extreme due to chance was <em>p</em> ‚âà <input type="text" class="blank" data-answer="0|0.0000|.0000|zero|0.00" style="width: 90px;">.
        </div>
        <div class="question">
            <span class="question-number">46.</span>
            Conclusion: We have <input type="text" class="blank" data-answer="statistically significant" style="width: 180px;"> evidence that the type of name on a r√©sum√© affects the likelihood of a callback.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part E: Statistical Inference & Generalization</h2>
            <span class="timestamp">[4:44‚Äì5:23]</span>
        </div>
        <div class="question">
            <span class="question-number">47.</span>
            Statistical inference: Decisions from the <input type="text" class="blank" data-answer="sample" style="width: 100px;"> can be attributed to the <input type="text" class="blank" data-answer="population" style="width: 120px;"> from which the sample was drawn.
        </div>
        <div class="question">
            <span class="question-number">48.</span>
            If experimental units are <input type="text" class="blank" data-answer="representative" style="width: 150px;"> of the population, then results can be generalized to the population.
        </div>
        <div class="question">
            <span class="question-number">49.</span>
            <input type="text" class="blank" data-answer="Random selection" style="width: 150px;"> of individuals gives a better chance that the sample will be representative.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part F: Key Takeaways</h2>
            <span class="timestamp">[5:23‚Äì5:50]</span>
        </div>
        <div class="question">
            <span class="question-number">50.</span>
            Statistical inference allows us to make <input type="text" class="blank" data-answer="decisions|conclusions" style="width: 130px;"> about populations or treatments based on sample data.
        </div>
        <div class="question">
            <span class="question-number">51.</span>
            Observed changes larger than can be attributed to chance are considered <input type="text" class="blank" data-answer="statistically significant" style="width: 180px;">.
        </div>
        <div class="question">
            <span class="question-number">52.</span>
            <input type="text" class="blank" data-answer="Random selection" style="width: 150px;"> of experimental units allows results to be generalized to the population of interest.
        </div>
    </div>

    <!-- ============ POST-VIDEO REFLECTION ============ -->
    <div class="section">
        <div class="section-header">
            <h2>Post-Video Reflection</h2>
        </div>
        <div class="question">
            <span class="question-number">53.</span>
            <strong>Random Selection vs. Random Assignment:</strong> Explain the difference and when each is used.
            <textarea id="reflect53" placeholder="Random selection is used when... Random assignment is used when..."></textarea>
        </div>
        <div class="question">
            <span class="question-number">54.</span>
            <strong>Evaluating an Experiment:</strong> A researcher wants to test whether a new fertilizer increases crop yield. She has 10 fields available, each with different soil types. She applies the new fertilizer to 5 fields and the old fertilizer to 5 fields, then measures yield.
            <div class="sub-questions" style="margin-top: 10px;">
                <div class="sub-question"><strong>(a)</strong> What is a potential confounding variable in this study?</div>
                <textarea id="reflect54a" placeholder="A potential confounding variable is..."></textarea>
                <div class="sub-question" style="margin-top: 10px;"><strong>(b)</strong> Propose an improved design using blocking.</div>
                <textarea id="reflect54b" placeholder="An improved design would..."></textarea>
            </div>
        </div>
        <div class="question">
            <span class="question-number">55.</span>
            <strong>Interpreting Statistical Significance:</strong> In a study comparing two medications, researchers found a statistically significant difference in recovery times (<em>p</em> = 0.02). What does this mean, and what can we conclude about causation?
            <textarea id="reflect55" placeholder="Statistical significance means..."></textarea>
        </div>
        <div class="question">
            <span class="question-number">56.</span>
            <strong>Generalization:</strong> Under what two conditions can the results of an experiment be generalized to a larger population?
            <textarea id="reflect56" placeholder="Results can be generalized when..."></textarea>
        </div>
    </div>

    <div class="exit-ticket">
        <strong>Exit Ticket:</strong> In 2‚Äì3 sentences, explain the relationship between random assignment, statistical significance, and establishing causation in experiments.
        <textarea id="exitTicket" placeholder="Random assignment allows us to... Statistical significance means... This establishes causation because..."></textarea>
    </div>

    <!-- Aggregate Drawer -->
    <div id="aggregateDrawer" class="aggregate-drawer">
        <div class="aggregate-header">
            <div class="aggregate-title" id="aggregateTitle">Class Answers</div>
            <button id="aggregateClose" class="aggregate-close" aria-label="Close drawer">√ó</button>
        </div>
        <div id="aggregateContent" class="aggregate-content">
            <!-- Charts will be inserted here -->
        </div>
    </div>

    <script src="../railway_config.js"></script>
    <script src="../railway_client.js"></script>
    <script>
        const WORKSHEET_ID = 'WS-U3L6-7';
        const LOCAL_USER_KEY = 'worksheet-user';
        let currentQuestionBlanks = [];
        const debounceMap = new Map();

        // ============ UTILITY FUNCTIONS ============
        function normalize(str) {
            return (str || '').trim().toLowerCase();
        }

        function normalizeForStore(str) {
            return (str || '').trim() || '(blank)';
        }

        // ============ ANSWER CHECKING ============
        function checkAnswer(blank) {
            const userAnswer = normalize(blank.value);
            const acceptedAnswers = (blank.dataset.answer || '').split('|').map(a => normalize(a));
            
            if (!userAnswer) {
                blank.classList.remove('correct', 'incorrect', 'partial');
                return null;
            }
            
            // Check for exact match first
            const isExactMatch = acceptedAnswers.some(accepted => userAnswer === accepted);
            
            // Check for partial match (contains or is contained)
            const isPartialMatch = !isExactMatch && acceptedAnswers.some(accepted => 
                userAnswer.includes(accepted) || accepted.includes(userAnswer)
            );
            
            blank.classList.remove('correct', 'incorrect', 'partial', 'revealed');
            
            if (isExactMatch) {
                blank.classList.add('correct');
                return 'correct';
            } else if (isPartialMatch) {
                blank.classList.add('partial');
                return 'partial';
            } else {
                blank.classList.add('incorrect');
                return 'incorrect';
            }
        }

        function checkAnswers() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            let correct = 0;
            let partial = 0;
            let total = 0;
            
            blanks.forEach(blank => {
                if (blank.value.trim()) {
                    total++;
                    const result = checkAnswer(blank);
                    if (result === 'correct') correct++;
                    else if (result === 'partial') partial++;
                } else {
                    blank.classList.remove('correct', 'incorrect', 'partial', 'revealed');
                }
            });
            
            const scoreDisplay = document.getElementById('scoreDisplay');
            if (total > 0) {
                const pct = Math.round((correct / total) * 100);
                let scoreText = `Score: ${correct}/${total} (${pct}%)`;
                if (partial > 0) {
                    scoreText += ` +${partial} partial`;
                }
                scoreDisplay.textContent = scoreText;
                scoreDisplay.classList.add('visible');
            } else {
                scoreDisplay.classList.remove('visible');
            }
            
            // Push all answers to server
            pushAllAnswers().then(() => refreshAllAggregates());
        }

        function showAnswers() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            blanks.forEach(blank => {
                const answers = (blank.dataset.answer || '').split('|');
                const primaryAnswer = answers[0];
                blank.value = primaryAnswer;
                blank.classList.remove('correct', 'incorrect');
                blank.classList.add('revealed');
            });
            
            document.getElementById('scoreDisplay').classList.remove('visible');
            pushAllAnswers().then(() => refreshAllAggregates());
        }

        function resetAnswers() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            blanks.forEach(blank => {
                blank.value = '';
                blank.classList.remove('correct', 'incorrect', 'partial', 'revealed');
            });
            
            const textareas = Array.from(document.querySelectorAll('textarea'));
            textareas.forEach(ta => ta.value = '');
            
            document.getElementById('scoreDisplay').classList.remove('visible');
        }

        // ============ QUESTION ID ASSIGNMENT ============
        function assignQuestionIds() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            blanks.forEach((blank, idx) => {
                blank.dataset.questionId = `${WORKSHEET_ID}-Q${idx + 1}`;
            });
        }

        // ============ SAVE INDICATORS ============
        function addSaveIndicators() {
            const questions = Array.from(document.querySelectorAll('.question'));
            questions.forEach(q => {
                if (q.querySelector('.save-indicator')) return;
                const indicator = document.createElement('span');
                indicator.className = 'save-indicator';
                indicator.textContent = '‚úì saved';
                q.appendChild(indicator);
            });
        }

        // ============ EVENT BINDING ============
        function bindBlankEvents() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            blanks.forEach(blank => {
                blank.addEventListener('blur', () => handleLiveUpdate(blank));
                blank.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleLiveUpdate(blank);
                        // Move to next blank
                        const allBlanks = Array.from(document.querySelectorAll('.blank'));
                        const idx = allBlanks.indexOf(blank);
                        if (idx < allBlanks.length - 1) {
                            allBlanks[idx + 1].focus();
                        }
                    }
                });
            });
        }

        function handleLiveUpdate(blank) {
            const username = getUsername();
            if (!username) {
                console.warn('Username is required to save answers.');
                return;
            }
            const questionId = blank.dataset.questionId;
            const answerValue = normalizeForStore(blank.value);
            if (!questionId) return;

            // Debounce per question
            const now = Date.now();
            const last = debounceMap.get(questionId) || 0;
            if (now - last < 250) return;
            debounceMap.set(questionId, now);

            sendAnswer(username, questionId, answerValue).then(() => {
                showSaved(blank);
                // Refresh drawer if this blank is in the current open question
                if (currentQuestionBlanks.includes(blank)) {
                    const questionEl = blank.closest('.question');
                    if (questionEl) {
                        renderAllBlanksInDrawer(currentQuestionBlanks, questionEl);
                    }
                }
            });
        }

        function showSaved(blank) {
            const indicator = blank.closest('.question')?.querySelector('.save-indicator');
            if (indicator) {
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 2000);
            }
            spawnParticleUp(blank);
        }

        function spawnParticleUp(blank) {
            const rect = blank.getBoundingClientRect();
            const particle = document.createElement('div');
            particle.className = 'particle-up';
            particle.textContent = '‚Üë';
            particle.style.left = `${rect.left + rect.width / 2}px`;
            particle.style.top = `${rect.top - 4 + window.scrollY}px`;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 900);
        }

        // ============ AGGREGATE BUTTONS ============
        function injectAggregateButtons() {
            const questions = Array.from(document.querySelectorAll('.question'));
            questions.forEach(q => {
                const blanks = q.querySelectorAll('.blank');
                if (blanks.length === 0) return;
                if (q.querySelector('.aggregate-trigger')) return;
                
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'aggregate-trigger';
                btn.textContent = 'üìä Class';
                btn.addEventListener('click', () => openDrawerForQuestion(q));
                q.appendChild(btn);
            });
        }

        // ============ USER MANAGEMENT ============
        function getUsername() {
            const usernameField = document.getElementById('worksheetUsername');
            const nameField = document.getElementById('studentName');
            const username = (usernameField?.value || '').trim();
            if (username) {
                try {
                    localStorage.setItem(LOCAL_USER_KEY, JSON.stringify({
                        username,
                        name: nameField?.value || '',
                        klass: document.getElementById('studentClass')?.value || ''
                    }));
                } catch (e) {
                    console.warn('Unable to persist username locally', e);
                }
                return username;
            }
            return '';
        }

        function restoreSavedUser() {
            try {
                const saved = JSON.parse(localStorage.getItem(LOCAL_USER_KEY) || '{}');
                if (saved.username) {
                    const usernameField = document.getElementById('worksheetUsername');
                    if (usernameField) usernameField.value = saved.username;
                }
                if (saved.name) {
                    const nameField = document.getElementById('studentName');
                    if (nameField) nameField.value = saved.name;
                }
                if (saved.klass) {
                    const classField = document.getElementById('studentClass');
                    if (classField) classField.value = saved.klass;
                }
            } catch (e) {
                console.warn('No saved user found', e);
            }
        }

        // ============ SERVER COMMUNICATION ============
        async function sendAnswer(username, questionId, answerValue) {
            const payload = {
                username,
                question_id: questionId,
                answer_value: answerValue,
                timestamp: Date.now()
            };

            if (window.railwayClient?.submitAnswer) {
                return window.railwayClient.submitAnswer(
                    payload.username,
                    payload.question_id,
                    payload.answer_value,
                    payload.timestamp
                );
            }

            const baseUrl = window.RAILWAY_SERVER_URL || '';
            if (!baseUrl) {
                console.warn('No Railway server configured; skipping live submit');
                return false;
            }

            try {
                const res = await fetch(`${baseUrl}/api/submit-answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                return !!result.success;
            } catch (e) {
                console.warn('Failed to submit answer:', e);
                return false;
            }
        }

        async function fetchQuestionStats(questionId) {
            if (window.railwayClient?.getStats) {
                const stats = await window.railwayClient.getStats(questionId);
                if (stats) return stats;
            }

            const baseUrl = window.RAILWAY_SERVER_URL || '';
            if (!baseUrl) return null;
            try {
                const res = await fetch(`${baseUrl}/api/question-stats/${encodeURIComponent(questionId)}`);
                if (!res.ok) return null;
                return await res.json();
            } catch (e) {
                console.warn('Unable to fetch stats', e);
                return null;
            }
        }

        async function pushAllAnswers() {
            const username = getUsername();
            if (!username) return;
            const blanks = Array.from(document.querySelectorAll('.blank'));
            for (const blank of blanks) {
                const questionId = blank.dataset.questionId;
                const answerValue = normalizeForStore(blank.value);
                if (questionId && answerValue !== '(blank)') {
                    await sendAnswer(username, questionId, answerValue);
                }
            }
        }

        // ============ AGGREGATE DRAWER ============
        function ensureDrawer() {
            const drawer = document.getElementById('aggregateDrawer');
            const closeBtn = document.getElementById('aggregateClose');
            if (closeBtn && !closeBtn.dataset.bound) {
                closeBtn.dataset.bound = 'true';
                closeBtn.addEventListener('click', () => {
                    drawer.classList.remove('open');
                    currentQuestionBlanks = [];
                });
            }
            return {
                drawer,
                titleEl: document.getElementById('aggregateTitle'),
                contentEl: document.getElementById('aggregateContent')
            };
        }

        function ensureRailwayDefaults() {
            if (typeof window.USE_RAILWAY === 'undefined') {
                window.USE_RAILWAY = true;
            }
            if (!window.RAILWAY_SERVER_URL) {
                window.RAILWAY_SERVER_URL = 'https://curriculumrender-production.up.railway.app';
            }
        }

        function openDrawerForQuestion(questionEl) {
            const { drawer, titleEl } = ensureDrawer();
            if (!drawer) return;
            
            const blanks = Array.from(questionEl.querySelectorAll('.blank'));
            if (blanks.length === 0) return;
            
            // Get question number from the question-number span
            const qNumEl = questionEl.querySelector('.question-number');
            const qNum = qNumEl ? qNumEl.textContent.replace('.', '') : '?';
            
            if (titleEl) titleEl.textContent = `Question ${qNum} - Class Answers`;
            
            currentQuestionBlanks = blanks;
            drawer.classList.add('open');
            
            renderAllBlanksInDrawer(blanks, questionEl);
        }
        
        async function renderAllBlanksInDrawer(blanks, questionEl) {
            const contentEl = document.getElementById('aggregateContent');
            if (!contentEl) return;
            
            contentEl.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">Loading...</div>';
            
            const chartContainers = [];
            
            for (let i = 0; i < blanks.length; i++) {
                const blank = blanks[i];
                const questionId = blank.dataset.questionId;
                
                // Get context around the blank
                const context = getBlankContext(blank, questionEl);
                
                // Fetch stats
                const stats = await fetchQuestionStats(questionId);
                
                // Create chart container
                const container = document.createElement('div');
                container.className = 'chart-container';
                
                // Label
                const label = document.createElement('div');
                label.className = 'chart-label';
                label.textContent = `Blank ${i + 1}: ${context}`;
                container.appendChild(label);
                
                if (!stats || !stats.responses || stats.responses.length === 0) {
                    // Check distribution fallback
                    if (stats && stats.distribution && Object.keys(stats.distribution).length > 0) {
                        const count = document.createElement('div');
                        count.className = 'chart-count';
                        const total = stats.totalResponses || Object.values(stats.distribution).reduce((a,b) => a + (typeof b === 'number' && b <= 100 ? 1 : b), 0);
                        count.textContent = `${total} response${total !== 1 ? 's' : ''}`;
                        container.appendChild(count);
                        
                        const chart = renderBarChartFromDistribution(stats.distribution, stats.totalResponses);
                        container.appendChild(chart);
                    } else {
                        const noData = document.createElement('div');
                        noData.style.cssText = 'color:#999; font-size:0.85em; padding:10px; text-align:center;';
                        noData.textContent = 'No responses yet';
                        container.appendChild(noData);
                    }
                } else {
                    const count = document.createElement('div');
                    count.className = 'chart-count';
                    count.textContent = `${stats.responses.length} response${stats.responses.length !== 1 ? 's' : ''}`;
                    container.appendChild(count);
                    
                    const chart = renderBarChartFromResponses(stats.responses);
                    container.appendChild(chart);
                }
                
                chartContainers.push(container);
            }
            
            contentEl.innerHTML = '';
            chartContainers.forEach(c => contentEl.appendChild(c));
            
            spawnPeerSnow();
        }
        
        function getBlankContext(blank, questionEl) {
            // Try to get some text around the blank to identify it
            const fullText = questionEl.textContent || '';
            const questionNum = questionEl.querySelector('.question-number');
            let text = fullText;
            if (questionNum) {
                text = text.replace(questionNum.textContent, '').trim();
            }
            
            // Find position of this blank
            const blanks = Array.from(questionEl.querySelectorAll('.blank'));
            const blankIndex = blanks.indexOf(blank);
            
            // Get HTML and find surrounding text
            const html = questionEl.innerHTML;
            const inputPattern = /<input[^>]*class="blank"[^>]*>/gi;
            const matches = [...html.matchAll(inputPattern)];
            
            if (matches[blankIndex]) {
                const matchStart = matches[blankIndex].index;
                // Get text before
                const beforeHtml = html.substring(Math.max(0, matchStart - 50), matchStart);
                const beforeText = beforeHtml.replace(/<[^>]+>/g, '').trim();
                // Get last few words
                const words = beforeText.split(/\s+/).slice(-4).join(' ');
                return `"...${words} ___"`;
            }
            
            return `Blank ${blankIndex + 1}`;
        }
        
        function renderBarChartFromResponses(responses) {
            // Group responses
            const groups = new Map();
            responses.forEach(r => {
                const key = normalize(r.answer);
                if (!key) return;
                if (!groups.has(key)) {
                    groups.set(key, { display: r.answer, count: 0 });
                }
                groups.get(key).count++;
            });
            
            return renderBarChartFromGroups(groups, responses.length);
        }
        
        function renderBarChartFromDistribution(distribution, totalResponses) {
            const groups = new Map();
            let calculatedTotal = 0;
            
            Object.entries(distribution).forEach(([answer, value]) => {
                if (!answer || answer === '(blank)') return;
                // If value looks like a percentage (and we have totalResponses), convert
                // Otherwise treat as count
                let count = value;
                if (totalResponses && value > totalResponses) {
                    // This is probably a percentage
                    count = Math.round((value / 100) * totalResponses);
                }
                if (count < 1) count = 1; // At least 1 if it appears
                
                calculatedTotal += count;
                groups.set(normalize(answer), { display: answer, count: count });
            });
            
            return renderBarChartFromGroups(groups, totalResponses || calculatedTotal);
        }
        
        function renderBarChartFromGroups(groups, total) {
            const chart = document.createElement('div');
            chart.className = 'bar-chart';
            
            // Sort by count descending
            const sorted = Array.from(groups.values())
                .sort((a, b) => b.count - a.count)
                .slice(0, 8); // Top 8
            
            const maxCount = Math.max(...sorted.map(g => g.count), 1);
            
            // Color palette for bars
            const colors = [
                '#4e79a7', '#f28e2b', '#e15759', '#76b7b2', 
                '#59a14f', '#edc948', '#b07aa1', '#ff9da7'
            ];
            
            sorted.forEach((group, i) => {
                const row = document.createElement('div');
                row.className = 'bar-row';
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = truncateLabel(group.display, 15);
                label.title = group.display; // Full text on hover
                row.appendChild(label);
                
                const track = document.createElement('div');
                track.className = 'bar-track';
                
                const widthPercent = (group.count / maxCount) * 100;
                const fill = document.createElement('div');
                fill.className = 'bar-fill';
                fill.style.width = `${widthPercent}%`;
                fill.style.backgroundColor = colors[i % colors.length];
                
                const value = document.createElement('span');
                value.className = 'bar-value';
                const pct = total > 0 ? Math.round((group.count / total) * 100) : 0;
                value.textContent = `${group.count} (${pct}%)`;
                
                // If bar is too narrow, put value outside
                if (widthPercent < 35) {
                    value.className = 'bar-value outside';
                    value.style.left = `${widthPercent + 2}%`;
                    track.appendChild(fill);
                    track.appendChild(value);
                } else {
                    fill.appendChild(value);
                    track.appendChild(fill);
                }
                
                row.appendChild(track);
                chart.appendChild(row);
            });
            
            if (sorted.length === 0) {
                chart.innerHTML = '<div style="color:#999; font-size:0.85em; padding:10px;">No responses</div>';
            }
            
            return chart;
        }
        
        function truncateLabel(str, maxLen) {
            if (!str) return '';
            if (str.length <= maxLen) return str;
            return str.substring(0, maxLen - 1) + '‚Ä¶';
        }

        function spawnPeerSnow() {
            const particle = document.createElement('div');
            particle.className = 'particle-snow';
            particle.textContent = '‚ùÑ';
            const x = window.innerWidth - 80 + Math.random() * 40;
            const y = 60 + Math.random() * 40 + window.scrollY;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 1400);
        }

        async function refreshAllAggregates() {
            // If drawer is open, refresh the current question's charts
            if (currentQuestionBlanks.length > 0) {
                const questionEl = currentQuestionBlanks[0].closest('.question');
                if (questionEl) {
                    await renderAllBlanksInDrawer(currentQuestionBlanks, questionEl);
                }
            }
        }

        // ============ INITIALIZATION ============
        function init() {
            ensureRailwayDefaults();
            restoreSavedUser();
            assignQuestionIds();
            addSaveIndicators();
            bindBlankEvents();
            injectAggregateButtons();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>