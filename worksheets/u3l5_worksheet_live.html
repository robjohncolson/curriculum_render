<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic 3.5: Introduction to Experimental Design</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background: #f9f9f9;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .header-left { font-weight: bold; color: #003366; }
        .header-center { font-weight: bold; }
        .header-right { font-weight: bold; color: #003366; }
        
        h1 {
            text-align: center;
            color: #003366;
            margin-bottom: 5px;
        }
        
        .subtitle {
            text-align: center;
            font-style: italic;
            color: #555;
            margin-bottom: 10px;
        }
        
        .worksheet-label {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .student-info {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .student-info label {
            font-weight: bold;
        }
        
        .student-info input {
            border: none;
            border-bottom: 1px solid #333;
            background: transparent;
            padding: 2px 5px;
            font-size: 1em;
        }
        
        .objective-box {
            border: 2px solid #003366;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            background: white;
        }
        
        .objective-box strong {
            color: #003366;
        }
        
        .vocab-box {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .vocab-box h3 {
            margin-top: 0;
            color: #003366;
        }
        
        .vocab-table {
            width: 100%;
        }
        
        .vocab-table td {
            padding: 5px 0;
            vertical-align: top;
        }
        
        .vocab-table td:first-child {
            font-weight: bold;
            width: 180px;
            color: #003366;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        
        .section-header h2 {
            margin: 0;
            color: #003366;
            font-size: 1.2em;
        }
        
        .timestamp {
            color: #666;
            font-size: 0.9em;
            font-weight: normal;
        }
        
        .question {
            margin-bottom: 15px;
            padding-left: 25px;
            position: relative;
        }
        
        .question-number {
            position: absolute;
            left: 0;
            font-weight: bold;
            color: #003366;
        }
        
        .blank {
            display: inline-block;
            min-width: 100px;
            border-bottom: 2px solid #003366;
            padding: 2px 8px;
            margin: 0 3px;
            background: #fff;
            font-size: 1em;
            transition: all 0.3s;
        }
        
        .blank:focus {
            outline: none;
            border-bottom-color: #0066cc;
            background: #f0f7ff;
        }
        
        .blank.correct {
            background: #d4edda;
            border-bottom-color: #28a745;
        }
        
        .blank.incorrect {
            background: #f8d7da;
            border-bottom-color: #dc3545;
        }
        
        .model-box {
            border: 1px solid #003366;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            background: white;
        }
        
        .model-box h4 {
            margin-top: 0;
            color: #003366;
            background: #003366;
            color: white;
            margin: -15px -15px 15px -15px;
            padding: 10px 15px;
            border-radius: 4px 4px 0 0;
        }
        
        .model-step {
            margin-bottom: 10px;
        }
        
        .model-step strong {
            color: #003366;
        }
        
        .reflection-box {
            margin-top: 30px;
        }
        
        .reflection-question {
            margin-bottom: 20px;
        }
        
        .reflection-question strong {
            color: #003366;
        }
        
        .reflection-question textarea {
            width: 100%;
            min-height: 80px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1em;
            resize: vertical;
        }
        
        .sub-questions {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .sub-question {
            margin-bottom: 10px;
        }
        
        .exit-ticket {
            background: #f0f0f0;
            border: 2px solid #003366;
            border-radius: 5px;
            padding: 15px;
            margin-top: 30px;
        }
        
        .exit-ticket h3 {
            margin-top: 0;
            color: #003366;
        }
        
        .exit-ticket textarea {
            width: 100%;
            min-height: 80px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1em;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .check-btn {
            background: #003366;
            color: white;
        }
        
        .check-btn:hover {
            background: #004488;
        }
        
        .reset-btn {
            background: #6c757d;
            color: white;
        }
        
        .reset-btn:hover {
            background: #5a6268;
        }
        
        .show-btn {
            background: #28a745;
            color: white;
        }
        
        .show-btn:hover {
            background: #218838;
        }
        
        .score-display {
            text-align: center;
            font-size: 1.3em;
            padding: 15px;
            background: #003366;
            color: white;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .score-display.visible {
            display: block;
        }
        
        .hint {
            font-style: italic;
            color: #666;
            font-size: 0.9em;
        }
        
        .aggregate-drawer {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 360px;
            max-width: 92vw;
            background: #f8fbff;
            border: 1px solid #cddff7;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 14px;
            z-index: 9999;
            display: none;
        }

        .aggregate-drawer.open {
            display: block;
        }

        .aggregate-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.92em;
            color: #003366;
            margin-bottom: 8px;
        }

        .aggregate-meta {
            color: #555;
            font-size: 0.85em;
        }

        .aggregate-trigger {
            margin-left: 8px;
            padding: 4px 10px;
            font-size: 0.85em;
            background: #e8f0ff;
            border: 1px solid #c5d6ff;
            border-radius: 6px;
            color: #003366;
            cursor: pointer;
        }

        .aggregate-trigger:hover {
            background: #d7e6ff;
        }

        .live-note {
            margin: -5px 0 20px;
            color: #444;
            font-size: 0.95em;
        }

        .submit-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.85em;
            color: #2e7d32;
            margin-left: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .submit-indicator.visible {
            opacity: 1;
        }

        .particle-up {
            position: fixed;
            pointer-events: none;
            color: #2e7d32;
            font-size: 16px;
            animation: floatUp 0.9s ease-out forwards;
            z-index: 9999;
        }

        .particle-snow {
            position: fixed;
            pointer-events: none;
            color: #5dade2;
            font-size: 14px;
            animation: snowDrift 1.4s ease-out forwards;
            z-index: 9999;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-30px); }
        }

        @keyframes snowDrift {
            0% { opacity: 0.9; transform: translateY(0) translateX(0) rotate(0deg); }
            100% { opacity: 0; transform: translateY(24px) translateX(-8px) rotate(18deg); }
        }
        
        @media print {
            .controls, .score-display { display: none !important; }
            .blank { border-bottom: 1px solid #000; }
        }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .header { flex-direction: column; gap: 5px; }
            .student-info { flex-direction: column; }
            .blank { min-width: 80px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="header-left">AP Statistics</span>
        <span class="header-center">Unit 3: Collecting Data</span>
        <span class="header-right">Lesson 3.5</span>
    </div>
    
    <h1>Topic 3.5: Introduction to Experimental Design</h1>
    <p class="subtitle">How do we design studies that can establish causation?</p>
    <p class="worksheet-label">Video Follow-Along Worksheet (Videos 1-3)</p>

    <div class="student-info">
        <label>Name: <input type="text" id="studentName" placeholder="Display name"></label>
        <label>Username: <input type="text" id="worksheetUsername" placeholder="Quiz username (required for live sync)"></label>
        <label>Class/Period: <input type="text" id="studentClass" placeholder="Optional"></label>
    </div>
    <p class="live-note">Use the same username you use in the quiz app to see your classmates' answers update live.</p>
    
    <div class="score-display" id="scoreDisplay"></div>
    
    <div class="objective-box">
        <strong>Learning Objectives:</strong>
        <ul>
            <li><strong>VAR-3.A:</strong> Identify the components of an experiment.</li>
            <li><strong>VAR-3.B:</strong> Describe the elements of a well-designed experiment.</li>
            <li><strong>VAR-3.C:</strong> Compare experimental designs and methods.</li>
        </ul>
        <strong>Essential Knowledge:</strong> Well-designed experiments can establish evidence of causal relationships through comparisons, random assignment, replication, and control of confounding variables.
    </div>
    
    <div class="vocab-box">
        <h3>Key Vocabulary</h3>
        <table class="vocab-table">
            <tr>
                <td>Experiment</td>
                <td>A study where treatments are intentionally imposed on experimental units to observe a response.</td>
            </tr>
            <tr>
                <td>Experimental units</td>
                <td>The individuals (people, animals, objects) to which treatments are applied.</td>
            </tr>
            <tr>
                <td>Confounding variable</td>
                <td>A variable related to the explanatory variable that also influences the response, creating a false perception of association.</td>
            </tr>
            <tr>
                <td>Random assignment</td>
                <td>Using chance to determine which treatment each experimental unit receives.</td>
            </tr>
            <tr>
                <td>Placebo</td>
                <td>A fake treatment similar in appearance to the real treatment.</td>
            </tr>
            <tr>
                <td>Blinding</td>
                <td>When subjects and/or researchers do not know which treatment is being administered.</td>
            </tr>
        </table>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Video 1: Confounding and Components of an Experiment</h2>
            <span class="timestamp">[6:20]</span>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part A: The Problem with Observational Studies</h2>
            <span class="timestamp">[0:00-3:12]</span>
        </div>
        <div class="question">
            <span class="question-number">1.</span>
            Research question: Do students who take notes during AP Stats earn <input type="text" class="blank" data-answer="higher scores|higher grades|better grades" style="width: 130px;"> than students who just listen?
        </div>
        <div class="question">
            <span class="question-number">2.</span>
            One way to study this is through an <input type="text" class="blank" data-answer="observational study" style="width: 150px;">: observe student grades after the midterm and record which students regularly took notes.
        </div>
        <div class="question">
            <span class="question-number">3.</span>
            If the group who took notes earned higher grades, can we conclude taking notes caused the higher scores?
            <span class="hint">Circle one:</span> <input type="text" class="blank" data-answer="No|no" style="width: 60px;">
        </div>
        <div class="question">
            <span class="question-number">4.</span>
            Just because there is a <input type="text" class="blank" data-answer="correlation|association|relationship" style="width: 140px;"> does not automatically mean there is <input type="text" class="blank" data-answer="causation|cause and effect" style="width: 130px;">.
        </div>
        <div class="question">
            <span class="question-number">5.</span>
            A <strong>confounding variable</strong> is another variable that is related to the <input type="text" class="blank" data-answer="explanatory" style="width: 120px;"> variable and influences the <input type="text" class="blank" data-answer="response" style="width: 110px;"> variable.
        </div>
        <div class="question">
            <span class="question-number">6.</span>
            In this example, <input type="text" class="blank" data-answer="academic motivation|motivation" style="width: 170px;"> is a confounding variable because:
            <div class="sub-questions">
                <div class="sub-question">• Students who are academically motivated are more likely to <input type="text" class="blank" data-answer="take notes" style="width: 110px;">.</div>
                <div class="sub-question">• Students who are academically motivated are more likely to <input type="text" class="blank" data-answer="earn higher grades|get higher grades|score higher" style="width: 150px;">.</div>
            </div>
        </div>
        <div class="model-box">
            <h4>Confounding: Visualized</h4>
            <p>Fill in the confounding variable:</p>
            <p><input type="text" class="blank" data-answer="academic motivation|motivation" style="width: 200px;"> &rarr; Take notes &amp; Higher grades</p>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part B: What Is an Experiment?</h2>
            <span class="timestamp">[3:32-5:43]</span>
        </div>
        <div class="question">
            <span class="question-number">7.</span>
            An <strong>experiment</strong> is where a treatment or treatments are intentionally <input type="text" class="blank" data-answer="imposed" style="width: 110px;"> on the experimental units.
        </div>
        <div class="question">
            <span class="question-number">8.</span>
            <strong>Experimental units</strong> are the <input type="text" class="blank" data-answer="individuals|people|subjects" style="width: 140px;"> to which we apply the treatments. When experimental units are humans, we call them <input type="text" class="blank" data-answer="participants|subjects" style="width: 140px;"> or subjects.
        </div>
        <div class="question">
            <span class="question-number">9.</span>
            The <strong>explanatory variable</strong> (or <input type="text" class="blank" data-answer="factor" style="width: 90px;">) may help to predict a change in the response variable.
        </div>
        <div class="question">
            <span class="question-number">10.</span>
            The <strong>response variable</strong> is what we use to <input type="text" class="blank" data-answer="measure" style="width: 110px;"> the outcome of a study.
        </div>
        <div class="question">
            <span class="question-number">11.</span>
            <strong>Proposed experiment:</strong> Let students decide whether or not to take notes.
            <div class="sub-questions">
                <div class="sub-question">• Explanatory variable: Does the student take notes? (Levels: <input type="text" class="blank" data-answer="yes or no|yes/no|takes notes|does not take notes" style="width: 190px;">)</div>
                <div class="sub-question">• Response variable: <input type="text" class="blank" data-answer="midterm grade|exam grade|test score" style="width: 170px;">.</div>
            </div>
        </div>
        <div class="question">
            <span class="question-number">12.</span>
            Is this a well-designed experiment? <span class="hint">Circle one:</span> <input type="text" class="blank" data-answer="No|no" style="width: 60px;">
        </div>
        <div class="question">
            <span class="question-number">13.</span>
            Why or why not? Confounding is still possible because <input type="text" class="blank" data-answer="students self-select to take notes|more motivated students choose notes|self-selection" style="width: 240px;">.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part C: Key Takeaways</h2>
            <span class="timestamp">[5:59-6:20]</span>
        </div>
        <div class="question">
            <span class="question-number">14.</span>
            Observational studies cannot determine <input type="text" class="blank" data-answer="causation|cause and effect" style="width: 140px;"> due to possible <input type="text" class="blank" data-answer="confounding|confounding variables" style="width: 170px;">.
        </div>
        <div class="question">
            <span class="question-number">15.</span>
            An experiment intentionally imposes <input type="text" class="blank" data-answer="treatments" style="width: 130px;"> on the participants in order to observe a <input type="text" class="blank" data-answer="response|change in response" style="width: 170px;">.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Video 2: Elements of a Well-Designed Experiment</h2>
            <span class="timestamp">[6:58]</span>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part A: Four Principles of Experimental Design</h2>
            <span class="timestamp">[0:00-1:42]</span>
        </div>
        <div class="question">
            <span class="question-number">16.</span>
            A well-designed experiment must include:
            <table class="vocab-table" style="margin-top: 10px;">
                <tr>
                    <td style="width: 160px;">1. <input type="text" class="blank" data-answer="Comparison" style="width: 130px;"></td>
                    <td>Compare at least <input type="text" class="blank" data-answer="two|2" style="width: 70px;"> treatment groups (one could be a control group).</td>
                </tr>
                <tr>
                    <td>2. <input type="text" class="blank" data-answer="Random assignment|Randomization" style="width: 170px;"></td>
                    <td>Randomly assign treatments to experimental units to balance out confounding factors.</td>
                </tr>
                <tr>
                    <td>3. <input type="text" class="blank" data-answer="Replication" style="width: 130px;"></td>
                    <td>Use <input type="text" class="blank" data-answer="many|enough|multiple" style="width: 100px;"> experimental units in each treatment group.</td>
                </tr>
                <tr>
                    <td>4. <input type="text" class="blank" data-answer="Control" style="width: 120px;"></td>
                    <td>Control potential <input type="text" class="blank" data-answer="confounding variables|lurking variables" style="width: 200px;"> where appropriate.</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part B: Bulls-Eye! Example</h2>
            <span class="timestamp">[1:43-4:17]</span>
        </div>
        <div class="question">
            <span class="question-number">17.</span>
            Research question: Does painting eyes on cattle's rears reduce <input type="text" class="blank" data-answer="predation|lion attacks|attacks" style="width: 150px;">?
        </div>
        <div class="question">
            <span class="question-number">18.</span>
            A study in <input type="text" class="blank" data-answer="Botswana" style="width: 120px;"> randomly assigned cattle to receive one of three treatments:
            <div class="sub-questions">
                <div class="sub-question">• Treatment 1: <input type="text" class="blank" data-answer="eyespots|painted eyes|eyes painted" style="width: 150px;"> (683 cattle)</div>
                <div class="sub-question">• Treatment 2: <input type="text" class="blank" data-answer="cross mark|cross-marks|X mark" style="width: 150px;"> (543 cattle)</div>
                <div class="sub-question">• Treatment 3: <input type="text" class="blank" data-answer="unmarked|no mark|no paint" style="width: 150px;"> (835 cattle)</div>
            </div>
        </div>
        <div class="question">
            <span class="question-number">19.</span>
            Results: Of the 683 cattle with eyespots, <input type="text" class="blank" data-answer="0|zero" style="width: 70px;"> were attacked. <input type="text" class="blank" data-answer="4|four" style="width: 70px;"> cross-marked and <input type="text" class="blank" data-answer="15|fifteen" style="width: 70px;"> unmarked cattle were killed.
        </div>
        <div class="question">
            <span class="question-number">20.</span>
            This is an <input type="text" class="blank" data-answer="experiment" style="width: 120px;"> (not observational) because cattle were <input type="text" class="blank" data-answer="randomly assigned|assigned at random" style="width: 170px;"> to treatments.
        </div>
        <div class="question">
            <span class="question-number">21.</span>
            How was <strong>control</strong> achieved in this study? The experiment was conducted in the same general <input type="text" class="blank" data-answer="location|area" style="width: 120px;"> during the same general <input type="text" class="blank" data-answer="time|season|period" style="width: 120px;">.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part C: Experimental Design Diagram</h2>
            <span class="timestamp">[4:18-6:27]</span>
        </div>
        <div class="question">
            <span class="question-number">22.</span>
            Complete the experimental design diagram:
            <div class="model-box">
                <p>Cattle &rarr; <input type="text" class="blank" data-answer="Random assignment|Randomization" style="width: 160px;"> &rarr; three groups &rarr; treatments &rarr; compare proportion killed.</p>
                <div class="sub-questions">
                    <div class="sub-question">Group 1 treatment: <input type="text" class="blank" data-answer="eyespots|painted eyes" style="width: 150px;"></div>
                    <div class="sub-question">Group 2 treatment: <input type="text" class="blank" data-answer="cross mark|cross-marks|X mark" style="width: 150px;"></div>
                    <div class="sub-question">Group 3 treatment: <input type="text" class="blank" data-answer="unmarked|no paint" style="width: 150px;"></div>
                </div>
            </div>
        </div>
        <div class="question">
            <span class="question-number">23.</span>
            Important note: On the AP Exam, simply providing a diagram may not give full credit. You must also explain <input type="text" class="blank" data-answer="how" style="width: 80px;"> the random assignment is performed.
        </div>
        <div class="question">
            <span class="question-number">24.</span>
            One method: Number all cattle from 1 to N. Use a <input type="text" class="blank" data-answer="random number generator|random digit table" style="width: 200px;"> to select which cattle go to each group. Continue until the desired number are assigned to each treatment group.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part D: Key Takeaways</h2>
            <span class="timestamp">[6:38-6:58]</span>
        </div>
        <div class="question">
            <span class="question-number">25.</span>
            A well-designed experiment should include:
            <div class="sub-questions">
                <div class="sub-question">• <input type="text" class="blank" data-answer="Comparison" style="width: 140px;"> between at least two groups</div>
                <div class="sub-question">• Random <input type="text" class="blank" data-answer="assignment" style="width: 130px;"> of treatments to experimental units</div>
                <div class="sub-question">• <input type="text" class="blank" data-answer="Replication" style="width: 140px;"> of treatments to multiple experimental units</div>
                <div class="sub-question">• <input type="text" class="blank" data-answer="Control" style="width: 130px;"> of possible confounding factors</div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Video 3: Experimental Designs and Methods</h2>
            <span class="timestamp">[10:11]</span>
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part A: Completely Randomized Design</h2>
            <span class="timestamp">[0:00-3:12]</span>
        </div>
        <div class="question">
            <span class="question-number">26.</span>
            Example: A melanoma treatment study compared standard care to a combination treatment. The <input type="text" class="blank" data-answer="survival rate|survival" style="width: 140px;"> was measured in both groups.
        </div>
        <div class="question">
            <span class="question-number">27.</span>
            The study is described as: "randomized, <input type="text" class="blank" data-answer="controlled|placebo-controlled" style="width: 160px;">, <input type="text" class="blank" data-answer="double-blind" style="width: 140px;">".
        </div>
        <div class="question">
            <span class="question-number">28.</span>
            In a <strong>completely randomized design</strong>, treatments are assigned to experimental units completely at <input type="text" class="blank" data-answer="random" style="width: 120px;">.
        </div>
        <div class="question">
            <span class="question-number">29.</span>
            Benefit: Random assignment tends to <input type="text" class="blank" data-answer="balance out|spread out" style="width: 150px;"> the effects of confounding variables so that differences in responses can be attributed to <input type="text" class="blank" data-answer="treatments|the treatment" style="width: 150px;">.
        </div>
        <div class="question">
            <span class="question-number">30.</span>
            Limitation: There may still be something about the <input type="text" class="blank" data-answer="volunteers|sample|patients" style="width: 150px;"> that affects results.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part B: Randomized Block Design</h2>
            <span class="timestamp">[3:13-5:26]</span>
        </div>
        <div class="question">
            <span class="question-number">31.</span>
            A <strong>Randomized Block Design</strong> ensures that experimental units within each <input type="text" class="blank" data-answer="block" style="width: 110px;"> are similar with respect to a blocking variable.
        </div>
        <div class="question">
            <span class="question-number">32.</span>
            Blocking helps to separate <input type="text" class="blank" data-answer="treatment effects|effects of treatments" style="width: 200px;"> from differences due to the blocking variable.
        </div>
        <div class="question">
            <span class="question-number">33.</span>
            In the melanoma study, <input type="text" class="blank" data-answer="disease severity|stage of melanoma|severity" style="width: 190px;"> could be a blocking variable because the treatment may work differently for more severe vs. less severe cases.
        </div>
        <div class="question">
            <span class="question-number">34.</span>
            Key distinction: Blocking is <strong>not</strong> random. It is done by the <input type="text" class="blank" data-answer="researcher|experimenter" style="width: 150px;">. Then, <strong>within</strong> each block, we <input type="text" class="blank" data-answer="randomly assign treatments|randomize" style="width: 200px;">.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part C: Placebo and the Placebo Effect</h2>
            <span class="timestamp">[5:27-7:38]</span>
        </div>
        <div class="question">
            <span class="question-number">35.</span>
            A <strong>placebo</strong> is a "<input type="text" class="blank" data-answer="fake|dummy" style="width: 90px;">" treatment that is similar to the treatment being tested.
        </div>
        <div class="question">
            <span class="question-number">36.</span>
            Why use a placebo? So that all patients behave the same way (for example, come in at the same <input type="text" class="blank" data-answer="time|schedule|frequency" style="width: 120px;">) regardless of which group they are in.
        </div>
        <div class="question">
            <span class="question-number">37.</span>
            The <strong>placebo effect</strong> occurs when experimental units have a <input type="text" class="blank" data-answer="response|positive response|improvement" style="width: 170px;"> to a placebo. This is a naturally occurring phenomenon.
        </div>
        <div class="question">
            <span class="question-number">38.</span>
            Using a placebo helps determine if an effect is truly due to the <input type="text" class="blank" data-answer="treatment" style="width: 130px;"> or just from receiving some treatment.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part D: Blinding</h2>
            <span class="timestamp">[7:39-8:13]</span>
        </div>
        <div class="question">
            <span class="question-number">39.</span>
            <strong>Single-blind experiment:</strong> The <input type="text" class="blank" data-answer="subjects|participants" style="width: 150px;"> do not know which treatment they are receiving, but the researchers do (or vice versa).
        </div>
        <div class="question">
            <span class="question-number">40.</span>
            <strong>Double-blind experiment:</strong> Neither the <input type="text" class="blank" data-answer="subjects|participants" style="width: 150px;"> nor the <input type="text" class="blank" data-answer="researchers|experimenters|evaluators" style="width: 190px;"> who interact with them know which treatment is being administered.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part E: Matched Pairs Design</h2>
            <span class="timestamp">[8:14-9:28]</span>
        </div>
        <div class="question">
            <span class="question-number">41.</span>
            <strong>Matched Pairs Design</strong> is a special type of block design where each block has size <input type="text" class="blank" data-answer="2|two" style="width: 80px;">.
        </div>
        <div class="question">
            <span class="question-number">42.</span>
            Pairs are arranged such that the two units are very closely <input type="text" class="blank" data-answer="matched|similar" style="width: 130px;"> on relevant factors (like twins!).
        </div>
        <div class="question">
            <span class="question-number">43.</span>
            Within each pair, <input type="text" class="blank" data-answer="randomization|random assignment" style="width: 170px;"> is used to determine which unit receives which treatment.
        </div>
        <div class="question">
            <span class="question-number">44.</span>
            Alternate form: Each subject may receive <input type="text" class="blank" data-answer="both treatments|each treatment" style="width: 170px;">, with randomization to determine the <input type="text" class="blank" data-answer="order|sequence" style="width: 120px;"> of treatments.
        </div>
    </div>

    <div class="section">
        <div class="section-header">
            <h2>Part F: Key Takeaways</h2>
            <span class="timestamp">[9:29-10:11]</span>
        </div>
        <div class="question">
            <span class="question-number">45.</span>
            A completely randomized design helps to <input type="text" class="blank" data-answer="balance|spread out" style="width: 140px;"> potential confounding variables.
        </div>
        <div class="question">
            <span class="question-number">46.</span>
            Block design ensures <input type="text" class="blank" data-answer="similarity within blocks|homogeneity" style="width: 200px;"> within blocks before randomization of treatments.
        </div>
        <div class="question">
            <span class="question-number">47.</span>
            The use of a <input type="text" class="blank" data-answer="placebo" style="width: 120px;"> helps determine if an effect is truly due to the treatment.
        </div>
        <div class="question">
            <span class="question-number">48.</span>
            <input type="text" class="blank" data-answer="Blinding" style="width: 120px;"> occurs when subjects and/or researchers are unaware of the treatment.
        </div>
    </div>

    <div class="reflection-box">
        <div class="section-header">
            <h2>Post-Video Reflection</h2>
        </div>
        <div class="question">
            <span class="question-number">49.</span>
            <strong>Identifying Components:</strong> A pharmaceutical company wants to test whether a new pain medication is more effective than a current medication. They randomly assign 200 patients with chronic back pain to receive either the new medication or the current medication for 4 weeks, then measure pain levels.
            <div class="sub-questions">
                <div class="sub-question">• Experimental units: <input type="text" class="blank" data-answer="200 patients with chronic back pain|patients" style="width: 240px;"></div>
                <div class="sub-question">• Explanatory variable (factor): <input type="text" class="blank" data-answer="type of medication|which medication|new vs current medication" style="width: 260px;"></div>
                <div class="sub-question">• Treatments: <input type="text" class="blank" data-answer="new medication and current medication|new vs current medication" style="width: 240px;"></div>
                <div class="sub-question">• Response variable: <input type="text" class="blank" data-answer="pain level after 4 weeks|pain levels|reported pain" style="width: 220px;"></div>
            </div>
        </div>
        <div class="question">
            <span class="question-number">50.</span>
            <strong>Design Improvement:</strong> The company is concerned that the severity of back pain (mild vs severe) might affect how well the medication works. What type of experimental design would address this concern, and how would it be implemented?
            <textarea placeholder="Hint: consider blocking by severity, then randomize within each block."></textarea>
        </div>
        <div class="question">
            <span class="question-number">51.</span>
            <strong>Critical Distinction:</strong> Explain the difference between <strong>random selection</strong> and <strong>random assignment</strong>. Which one allows us to generalize results? Which one allows us to establish causation?
            <textarea placeholder="Random selection -> generalize to population; random assignment -> causation."></textarea>
        </div>
        <div class="question">
            <span class="question-number">52.</span>
            <strong>Confounding Check:</strong> A researcher wants to determine if drinking coffee improves test scores. She surveys students about their coffee habits and compares their exam grades. Identify one potential confounding variable and explain why it creates a problem.
            <textarea placeholder="Example: study habits, sleep, or prior GPA could be confounding."></textarea>
        </div>
    </div>

    <div class="exit-ticket">
        <h3>Exit Ticket</h3>
        <p>In 2-3 sentences, explain why random assignment of treatments is essential for establishing a cause-and-effect relationship.</p>
        <textarea></textarea>
    </div>

    <div class="controls">
        <button class="check-btn" onclick="checkAnswers()">Check Answers</button>
        <button class="show-btn" onclick="showAnswers()">Show Answers</button>
        <button class="reset-btn" onclick="resetForm()">Reset</button>
    </div>

    <div class="aggregate-drawer" id="aggregateDrawer" aria-live="polite">
        <div class="aggregate-header">
            <span id="aggregateTitle">Class responses</span>
            <button type="button" id="aggregateClose" class="aggregate-trigger" style="margin-left:0;">Close</button>
        </div>
        <div class="aggregate-meta" id="aggregateCount"></div>
        <canvas id="aggregateCanvas" height="180"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../railway_config.js"></script>
    <script src="../railway_client.js"></script>

    <script>
        // Normalize answer for comparison
        function normalize(str) {
            return str.toLowerCase().trim()
                .replace(/[^\w\s]/g, '')
                .replace(/\s+/g, ' ');
        }
        
        // Check if answer is acceptable (handles multiple valid answers)
        function isCorrect(input, answer) {
            const userAnswer = normalize(input);
            const correctAnswers = answer.split('|').map(a => normalize(a));
            
            // Check for exact match or close match
            for (const correct of correctAnswers) {
                if (userAnswer === correct) return true;
                // Allow partial matches for longer answers
                if (correct.length > 5 && userAnswer.includes(correct)) return true;
                if (correct.length > 5 && correct.includes(userAnswer) && userAnswer.length > 3) return true;
            }
            return false;
        }
        
        function checkAnswers() {
            const blanks = document.querySelectorAll('.blank');
            let correct = 0;
            let total = 0;
            
            blanks.forEach(blank => {
                const answer = blank.dataset.answer;
                if (!answer) return;
                
                total++;
                const userValue = blank.value.trim();
                
                if (userValue === '') {
                    blank.classList.remove('correct', 'incorrect');
                } else if (isCorrect(userValue, answer)) {
                    blank.classList.add('correct');
                    blank.classList.remove('incorrect');
                    correct++;
                } else {
                    blank.classList.add('incorrect');
                    blank.classList.remove('correct');
                }
            });
            
            const scoreDisplay = document.getElementById('scoreDisplay');
            const percentage = total === 0 ? 0 : Math.round((correct / total) * 100);
            scoreDisplay.textContent = `Score: ${correct} / ${total} (${percentage}%)`;
            scoreDisplay.classList.add('visible');
        }
        
        function showAnswers() {
            const blanks = document.querySelectorAll('.blank');
            blanks.forEach(blank => {
                const answer = blank.dataset.answer;
                if (answer) {
                    blank.value = answer.split('|')[0];
                    blank.classList.add('correct');
                    blank.classList.remove('incorrect');
                }
            });
            
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.textContent = 'All answers shown';
            scoreDisplay.classList.add('visible');
        }
        
        function resetForm() {
            const blanks = document.querySelectorAll('.blank');
            blanks.forEach(blank => {
                blank.value = '';
                blank.classList.remove('correct', 'incorrect');
            });
            
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(ta => ta.value = '');
            
            const scoreDisplay = document.getElementById('scoreDisplay');
            scoreDisplay.classList.remove('visible');
        }
        
        // Allow Enter key to move to next blank
        document.querySelectorAll('.blank').forEach((blank, index, blanks) => {
            blank.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextBlank = blanks[index + 1];
                    if (nextBlank) nextBlank.focus();
                }
            });
        });

        // --- Live sync + aggregate charts ---
        const WORKSHEET_ID = 'WS-U3L5';
        const chartInstances = {};
        const LOCAL_USER_KEY = 'worksheetLiveUser';
        const debounceTimers = {};
        let currentDrawerQuestionId = null;

        function assignQuestionIds() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            blanks.forEach((blank, idx) => {
                if (!blank.dataset.questionId) {
                    blank.dataset.questionId = `${WORKSHEET_ID}-Q${idx + 1}`;
                }
            });
        }

        function attachLiveListeners() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            blanks.forEach(blank => {
                blank.addEventListener('blur', () => handleLiveUpdate(blank));
                blank.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleLiveUpdate(blank);
                    }
                });
                ensureIndicator(blank);
            });
        }

        function ensureIndicator(blank) {
            if (blank.nextElementSibling && blank.nextElementSibling.classList.contains('submit-indicator')) {
                return;
            }
            const indicator = document.createElement('span');
            indicator.className = 'submit-indicator';
            indicator.innerHTML = '✓ saved';
            blank.insertAdjacentElement('afterend', indicator);
        }

        function markSubmitted(blank) {
            const indicator = blank.nextElementSibling && blank.nextElementSibling.classList.contains('submit-indicator')
                ? blank.nextElementSibling
                : null;
            if (indicator) {
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 2000);
            }
            spawnParticleUp(blank);
        }

        function spawnParticleUp(blank) {
            const rect = blank.getBoundingClientRect();
            const particle = document.createElement('div');
            particle.className = 'particle-up';
            particle.textContent = '↑';
            particle.style.left = `${rect.left + rect.width / 2}px`;
            particle.style.top = `${rect.top - 4 + window.scrollY}px`;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 900);
        }

        function injectAggregateButtons() {
            const questions = Array.from(document.querySelectorAll('.question'));
            questions.forEach(q => {
                const blank = q.querySelector('.blank');
                if (!blank) return;
                if (q.querySelector('.aggregate-trigger')) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'aggregate-trigger';
                btn.textContent = 'Class answers';
                btn.addEventListener('click', () => openDrawerFor(blank));
                q.appendChild(btn);
            });
        }

        function getUsername() {
            const usernameField = document.getElementById('worksheetUsername');
            const nameField = document.getElementById('studentName');
            const username = (usernameField?.value || '').trim();
            if (username) {
                try {
                    localStorage.setItem(LOCAL_USER_KEY, JSON.stringify({
                        username,
                        name: nameField?.value || '',
                        klass: document.getElementById('studentClass')?.value || ''
                    }));
                } catch (e) {
                    console.warn('Unable to persist username locally', e);
                }
                return username;
            }
            return '';
        }

        function restoreSavedUser() {
            try {
                const saved = JSON.parse(localStorage.getItem(LOCAL_USER_KEY) || '{}');
                if (saved.username) {
                    const usernameField = document.getElementById('worksheetUsername');
                    if (usernameField) usernameField.value = saved.username;
                }
                if (saved.name) {
                    const nameField = document.getElementById('studentName');
                    if (nameField) nameField.value = saved.name;
                }
                if (saved.klass) {
                    const classField = document.getElementById('studentClass');
                    if (classField) classField.value = saved.klass;
                }
            } catch (e) {
                console.warn('No saved user found', e);
            }
        }

        function normalizeForStore(str) {
            return normalize(str) || '(blank)';
        }

        async function sendAnswer(username, questionId, answerValue) {
            const payload = {
                username,
                question_id: questionId,
                answer_value: answerValue,
                timestamp: Date.now()
            };

            if (window.railwayClient?.submitAnswer) {
                return window.railwayClient.submitAnswer(
                    payload.username,
                    payload.question_id,
                    payload.answer_value,
                    payload.timestamp
                );
            }

            const baseUrl = window.RAILWAY_SERVER_URL || '';
            if (!baseUrl) {
                console.warn('No Railway server configured; skipping live submit');
                return false;
            }

            const res = await fetch(`${baseUrl}/api/submit-answer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await res.json();
            return !!result.success;
        }

        async function refreshAggregate(questionId, correctAnswers) {
            await renderAggregate(questionId, correctAnswers);
        }

        async function fetchQuestionStats(questionId) {
            if (window.railwayClient?.getStats) {
                const stats = await window.railwayClient.getStats(questionId);
                if (stats) return stats;
            }

            const baseUrl = window.RAILWAY_SERVER_URL || '';
            if (!baseUrl) return null;
            try {
                const res = await fetch(`${baseUrl}/api/question-stats/${encodeURIComponent(questionId)}`);
                if (!res.ok) return null;
                return await res.json();
            } catch (e) {
                console.warn('Unable to fetch stats', e);
                return null;
            }
        }

        function ensureDrawer() {
            const drawer = document.getElementById('aggregateDrawer');
            const closeBtn = document.getElementById('aggregateClose');
            if (closeBtn && !closeBtn.dataset.bound) {
                closeBtn.dataset.bound = 'true';
                closeBtn.addEventListener('click', () => {
                    drawer.classList.remove('open');
                    currentDrawerQuestionId = null;
                });
            }
            return {
                drawer,
                titleEl: document.getElementById('aggregateTitle'),
                countEl: document.getElementById('aggregateCount'),
                canvas: document.getElementById('aggregateCanvas')
            };
        }

        function ensureRailwayDefaults() {
            if (typeof window.USE_RAILWAY === 'undefined') {
                window.USE_RAILWAY = true;
            }
            if (!window.RAILWAY_SERVER_URL) {
                window.RAILWAY_SERVER_URL = 'https://curriculumrender-production.up.railway.app';
            }
        }

        async function renderAggregate(questionId, correctAnswers) {
            const { canvas, countEl } = ensureDrawer();
            if (!canvas) return;
            const stats = await fetchQuestionStats(questionId);
            if (!stats) return;
            spawnPeerSnow();

            const distribution = stats.distribution || {};
            const labelsSet = new Set(Object.keys(distribution));

            const labels = Array.from(labelsSet).filter(Boolean);
            const counts = labels.map(label => distribution[label] ?? 0);
            const colors = labels.map(() => 'rgba(54, 162, 235, 0.6)');

            if (chartInstances.aggregate) {
                chartInstances.aggregate.destroy();
            }

            chartInstances.aggregate = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Responses (%)',
                        data: counts,
                        backgroundColor: colors,
                        borderColor: 'rgba(0, 51, 102, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: value => `${value}%`
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.formattedValue}% (${Math.round((ctx.parsed.y / 100) * (stats.totalResponses || 0))} of ${stats.totalResponses || 0})`
                            }
                        }
                    }
                }
            });

            if (countEl) {
                countEl.textContent = `${stats.totalResponses || 0} responses`;
            }
        }

        function spawnPeerSnow() {
            const particle = document.createElement('div');
            particle.className = 'particle-snow';
            particle.textContent = '❄';
            const x = window.innerWidth - 80 + Math.random() * 40;
            const y = 60 + Math.random() * 40 + window.scrollY;
            particle.style.left = `${x}px`;
            particle.style.top = `${y}px`;
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 1400);
        }

        async function refreshAllAggregates() {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            const uniqueQuestions = new Map();
            blanks.forEach(blank => {
                if (blank.dataset.questionId && blank.dataset.answer) {
                    uniqueQuestions.set(blank.dataset.questionId, blank.dataset.answer.split('|'));
                }
            });

            if (currentDrawerQuestionId && uniqueQuestions.has(currentDrawerQuestionId)) {
                await renderAggregate(currentDrawerQuestionId, uniqueQuestions.get(currentDrawerQuestionId));
            }
        }

        function handleLiveUpdate(blank) {
            const username = getUsername();
            if (!username) return;
            const questionId = blank.dataset.questionId;
            const correctAnswers = (blank.dataset.answer || '').split('|');
            if (!questionId) return;

            if (debounceTimers[questionId]) {
                clearTimeout(debounceTimers[questionId]);
            }
            debounceTimers[questionId] = setTimeout(async () => {
                await sendAnswer(username, questionId, normalizeForStore(blank.value));
                markSubmitted(blank);
                if (currentDrawerQuestionId === questionId) {
                    await refreshAggregate(questionId, correctAnswers);
                }
            }, 400);
        }

        function openDrawerFor(blank) {
            const questionId = blank.dataset.questionId;
            const correctAnswers = (blank.dataset.answer || '').split('|');
            if (!questionId) return;
            const { drawer, titleEl } = ensureDrawer();
            currentDrawerQuestionId = questionId;
            if (titleEl) {
                titleEl.textContent = `Class responses for ${questionId}`;
            }
            drawer.classList.add('open');
            renderAggregate(questionId, correctAnswers);
        }

        async function submitWorksheetResponses() {
            const username = getUsername();
            if (!username) {
                console.warn('Username is required for live sync; skipping submit.');
                return;
            }

            ensureRailwayDefaults();
            const blanks = Array.from(document.querySelectorAll('.blank'));
            const submissions = blanks
                .filter(b => b.dataset.questionId)
                .map(b => sendAnswer(username, b.dataset.questionId, normalizeForStore(b.value)));

            await Promise.all(submissions);
        }

        const originalCheckAnswers = window.checkAnswers || function() {};
        window.checkAnswers = async function() {
            try {
                await originalCheckAnswers();
            } catch (e) {
                console.error('checkAnswers failed:', e);
            }
            await submitWorksheetResponses();
            await refreshAllAggregates();
        };

        const originalShowAnswers = window.showAnswers || function() {};
        window.showAnswers = async function() {
            try {
                await originalShowAnswers();
            } catch (e) {
                console.error('showAnswers failed:', e);
            }
            await refreshAllAggregates();
        };

        document.addEventListener('DOMContentLoaded', () => {
            assignQuestionIds();
            attachLiveListeners();
            injectAggregateButtons();
            restoreSavedUser();
            ensureRailwayDefaults();
            refreshAllAggregates();
        });
    </script>
</body>
</html>
